import json
import sys
import base64
import os
import traceback
import random
from datetime import datetime
from PyQt6.QtWidgets import *
from PyQt6.QtCore import Qt, QObject, pyqtSignal, QPropertyAnimation, QEasingCurve, pyqtProperty, QTimer, QSize, QRect
from PyQt6.QtGui import QAction, QGuiApplication, QColor, QPainter, QBrush, QPixmap, QIcon
from .network import ClientNetwork
from .dropbox_manager import DropboxManager
from .crypto_utils import encrypt_msg, decrypt_msg
from .forensic_protection import get_forensic_protection, get_secure_storage
from .plausible_deniability import get_plausible_deniability

# ---------- SMOOTH OVERLAY ----------
class OverlayWidget(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAttribute(Qt.WidgetAttribute.WA_TransparentForMouseEvents, False)
        self._opacity = 0
        self.hide()

    @pyqtProperty(float)
    def opacity(self): return self._opacity

    @opacity.setter
    def opacity(self, value):
        self._opacity = value
        self.update()

    def paintEvent(self, event):
        painter = QPainter(self)
        color = QColor(0, 0, 0, int(self._opacity * 255))
        painter.fillRect(self.rect(), QBrush(color))

    def fade_in(self):
        self.show()
        self.raise_()
        self.ani = QPropertyAnimation(self, b"opacity")
        self.ani.setDuration(300)
        self.ani.setStartValue(0.0)
        self.ani.setEndValue(0.6)
        self.ani.setEasingCurve(QEasingCurve.Type.OutCubic)
        self.ani.start()

    def fade_out(self):
        self.ani = QPropertyAnimation(self, b"opacity")
        self.ani.setDuration(250)
        self.ani.setStartValue(self._opacity)
        self.ani.setEndValue(0.0)
        self.ani.finished.connect(self.hide)
        self.ani.start()

# ---------- SIDEBAR PANEL ----------
class SidebarPanel(QFrame):
    def __init__(self, parent):
        super().__init__(parent)
        self.setObjectName("SidebarPanel")
        self.setStyleSheet("""
            #SidebarPanel {
                background-color: #1e1e1e;
                border-right: 1px solid #333333;
            }
        """)
        self.is_open = False
        # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞
        self.setGeometry(-350, 0, 350, parent.height())
        
    def slide_in(self):
        """–ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏"""
        self.show()
        self.raise_()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
        parent_height = self.parent().height()
        
        self.ani = QPropertyAnimation(self, b"geometry")
        self.ani.setDuration(300)
        self.ani.setStartValue(QRect(-350, 0, 350, parent_height))
        self.ani.setEndValue(QRect(0, 0, 350, parent_height))
        self.ani.setEasingCurve(QEasingCurve.Type.OutCubic)
        self.ani.start()
        self.is_open = True
        
    def slide_out(self):
        """–ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏"""
        parent_height = self.parent().height()
        
        self.ani = QPropertyAnimation(self, b"geometry")
        self.ani.setDuration(250)
        self.ani.setStartValue(QRect(0, 0, 350, parent_height))
        self.ani.setEndValue(QRect(-350, 0, 350, parent_height))
        self.ani.setEasingCurve(QEasingCurve.Type.InCubic)
        self.ani.finished.connect(self.hide)
        self.ani.start()
        self.is_open = False

# ---------- PLAUSIBLE DENIABILITY DIALOG ----------
class PlausibleDeniabilityDialog(QFrame):
    def __init__(self, parent, on_confirm, on_cancel):
        super().__init__(parent)
        self.setObjectName("ConfirmDialog")
        self.setFixedSize(400, 250)
        self.on_confirm = on_confirm
        self.on_cancel = on_cancel
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.SubWindow)

        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title = QLabel("Plausible Deniability")
        title.setStyleSheet("font-size: 18px; font-weight: bold; border: none; background: transparent;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        # –û–ø–∏—Å–∞–Ω–∏–µ
        description = QLabel(
            "Set up a decoy password for plausible deniability.\n\n"
            "When you log in with this password, you'll see\n"
            "a fake chat with innocent messages."
        )
        description.setStyleSheet("font-size: 13px; border: none; background: transparent; color: #cccccc;")
        description.setWordWrap(True)
        description.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        # –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
        self.password_input = QLineEdit()
        self.password_input.setPlaceholderText("Enter decoy password...")
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        
        # –ö–Ω–æ–ø–∫–∏
        btn_layout = QHBoxLayout()
        self.confirm_btn = QPushButton("SET DECOY PASSWORD")
        self.confirm_btn.setObjectName("success")
        self.cancel_btn = QPushButton("CANCEL")
        self.cancel_btn.setObjectName("secondary")
        
        btn_layout.addWidget(self.confirm_btn)
        btn_layout.addWidget(self.cancel_btn)
        
        layout.addWidget(title)
        layout.addWidget(description)
        layout.addWidget(self.password_input)
        layout.addStretch()
        layout.addLayout(btn_layout)

        self.confirm_btn.clicked.connect(self.confirm)
        self.cancel_btn.clicked.connect(self.cancel)
        self.password_input.returnPressed.connect(self.confirm)

    def confirm(self):
        password = self.password_input.text().strip()
        if password:
            self.on_confirm(password)
        self.close_dialog()

    def cancel(self):
        self.on_cancel()
        self.close_dialog()
    
    def close_dialog(self):
        self.parent().fade_out()
        self.deleteLater()

# ---------- SETTINGS PANEL ----------
class SettingsPanel(QWidget):
    def __init__(self, parent, chat_window):
        super().__init__(parent)
        self.chat_window = chat_window
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header = QLabel("Settings")
        header.setStyleSheet("font-size: 20px; font-weight: bold;")
        
        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        line1 = QFrame()
        line1.setFrameShape(QFrame.Shape.HLine)
        line1.setStyleSheet("background-color: #333333;")
        
        # Enable Secure Mode (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
        secure_section = QWidget()
        secure_layout = QVBoxLayout(secure_section)
        secure_layout.setSpacing(10)
        
        secure_title = QLabel("Secure Mode")
        secure_title.setStyleSheet("font-size: 16px; font-weight: bold;")
        
        secure_desc = QLabel(
            "Enable forensic protection:\n"
            "‚Ä¢ Memory wiping after closing chats\n"
            "‚Ä¢ Secure file deletion\n"
            "‚Ä¢ Anti-recovery measures"
        )
        secure_desc.setStyleSheet("font-size: 12px; color: #888888;")
        
        self.secure_toggle = QPushButton("Enable Secure Mode")
        self.secure_toggle.setObjectName("secondary")
        self.secure_toggle.setCheckable(True)
        self.secure_toggle.clicked.connect(self.toggle_secure_mode)
        
        secure_layout.addWidget(secure_title)
        secure_layout.addWidget(secure_desc)
        secure_layout.addWidget(self.secure_toggle)
        
        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        line2 = QFrame()
        line2.setFrameShape(QFrame.Shape.HLine)
        line2.setStyleSheet("background-color: #333333;")
        
        # Plausible Deniability
        plausible_section = QWidget()
        plausible_layout = QVBoxLayout(plausible_section)
        plausible_layout.setSpacing(10)
        
        plausible_title = QLabel("Plausible Deniability")
        plausible_title.setStyleSheet("font-size: 16px; font-weight: bold;")
        
        plausible_desc = QLabel(
            "Create a decoy account with fake messages.\n"
            "Use a different password to access innocent chat."
        )
        plausible_desc.setStyleSheet("font-size: 12px; color: #888888;")
        
        self.plausible_btn = QPushButton("Setup Decoy Password")
        self.plausible_btn.setObjectName("secondary")
        self.plausible_btn.clicked.connect(self.setup_plausible_deniability)
        
        plausible_layout.addWidget(plausible_title)
        plausible_layout.addWidget(plausible_desc)
        plausible_layout.addWidget(self.plausible_btn)
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ
        layout.addWidget(header)
        layout.addWidget(line1)
        layout.addWidget(secure_section)
        layout.addWidget(line2)
        layout.addWidget(plausible_section)
        layout.addStretch()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º UI
        self.update_secure_toggle()
    
    def update_secure_toggle(self):
        forensic = get_forensic_protection()
        if forensic.is_secure_mode():
            self.secure_toggle.setText("Secure Mode ON")
            self.secure_toggle.setObjectName("success")
            self.secure_toggle.setChecked(True)
        else:
            self.secure_toggle.setText("Secure Mode OFF")
            self.secure_toggle.setObjectName("secondary")
            self.secure_toggle.setChecked(False)
        self.secure_toggle.setStyle(self.secure_toggle.style())
    
    def toggle_secure_mode(self):
        forensic = get_forensic_protection()
        
        if forensic.is_secure_mode():
            # –í—ã–∫–ª—é—á–∞–µ–º
            forensic.disable_secure_mode()
        else:
            # –í–∫–ª—é—á–∞–µ–º
            forensic.enable_secure_mode()        
        self.update_secure_toggle()
    
    def setup_plausible_deniability(self):
        self.chat_window.show_plausible_deniability_dialog()

# ---------- FILES PANEL ----------
class FilesPanel(QWidget):
    def __init__(self, parent, dropbox_mgr):
        super().__init__(parent)
        self.dropbox_mgr = dropbox_mgr
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header = QLabel("My Files")
        header.setStyleSheet("font-size: 20px; font-weight: bold;")
        
        # –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        status_layout = QHBoxLayout()
        self.status_label = QLabel()
        self.status_label.setObjectName("statusLabel")
        self.connect_btn = QPushButton("Connect Dropbox")
        self.disconnect_btn = QPushButton("Disconnect")
        self.disconnect_btn.setObjectName("danger")
        self.disconnect_btn.hide()
        
        status_layout.addWidget(self.status_label)
        status_layout.addStretch()
        status_layout.addWidget(self.connect_btn)
        status_layout.addWidget(self.disconnect_btn)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
        self.account_info = QLabel()
        self.account_info.setObjectName("infoLabel")
        self.account_info.hide()
        
        # –û–±–ª–∞—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setStyleSheet("QScrollArea { border: none; }")
        
        self.files_container = QWidget()
        self.files_layout = QGridLayout(self.files_container)
        self.files_layout.setSpacing(15)
        self.files_layout.setAlignment(Qt.AlignmentFlag.AlignTop | Qt.AlignmentFlag.AlignLeft)
        
        scroll_area.setWidget(self.files_container)
        
        # –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        self.refresh_btn = QPushButton("Refresh Files")
        self.refresh_btn.setObjectName("secondary")
        self.refresh_btn.setEnabled(False)
        
        layout.addWidget(header)
        layout.addLayout(status_layout)
        layout.addWidget(self.account_info)
        layout.addWidget(scroll_area)
        layout.addWidget(self.refresh_btn)
        
        self.connect_btn.clicked.connect(self.connect_dropbox)
        self.disconnect_btn.clicked.connect(self.disconnect_dropbox)
        self.refresh_btn.clicked.connect(self.refresh_files)
        
        self.update_status()
    
    def update_status(self):
        if self.dropbox_mgr.is_authenticated():
            self.status_label.setText("Connected")
            self.status_label.setStyleSheet("background-color: #28a745; padding: 5px; border-radius: 4px;")
            self.connect_btn.hide()
            self.disconnect_btn.show()
            self.refresh_btn.setEnabled(True)
            
            account = self.dropbox_mgr.get_account_info()
            if account:
                used_mb = account['used_space'] / (1024 * 1024)
                total_mb = account['allocated_space'] / (1024 * 1024)
                self.account_info.setText(
                    f"Account: {account['name']} ({account['email']}) | "
                    f"Space: {used_mb:.1f} MB / {total_mb:.1f} MB"
                )
                self.account_info.show()
            
            self.refresh_files()
        else:
            self.status_label.setText("Not connected")
            self.status_label.setStyleSheet("background-color: #bb2d3b; padding: 5px; border-radius: 4px;")
            self.connect_btn.show()
            self.disconnect_btn.hide()
            self.refresh_btn.setEnabled(False)
            self.account_info.hide()
            self.clear_files()
    
    def connect_dropbox(self):
        try:
            auth_url = self.dropbox_mgr.start_auth_flow()
            dialog = DropboxAuthDialog(self, auth_url)
            
            if dialog.exec() == QDialog.DialogCode.Accepted:
                code = dialog.get_code()
                if code:
                    success, message = self.dropbox_mgr.finish_auth_flow(code)
                    
                    if success:
                        QMessageBox.information(self, "Success", message)
                        self.update_status()
                    else:
                        QMessageBox.warning(self, "Error", message)
        
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Authorization failed: {str(e)}")
    
    def disconnect_dropbox(self):
        reply = QMessageBox.question(
            self, 
            "Disconnect", 
            "Are you sure you want to disconnect from Dropbox?\n"
            "You will need to re-authorize to access your files.",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            self.dropbox_mgr.disconnect()
            self.update_status()
    
    def clear_files(self):
        while self.files_layout.count():
            item = self.files_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
    
    def refresh_files(self):
        if not self.dropbox_mgr.is_authenticated():
            return
        
        self.clear_files()
        files = self.dropbox_mgr.list_files()
        
        for idx, file_info in enumerate(files):
            row = idx // 2
            col = idx % 2
            
            card = FileCardWidget(file_info, self.download_file, self.delete_file)
            self.files_layout.addWidget(card, row, col)
    
    def download_file(self, file_info):
        try:
            success, data, message = self.dropbox_mgr.download_file(file_info['path'])
            
            if success:
                save_path, _ = QFileDialog.getSaveFileName(
                    self,
                    "Save File",
                    file_info['name']
                )
                
                if save_path:
                    with open(save_path, 'wb') as f:
                        f.write(data)
                    QMessageBox.information(self, "Success", "File downloaded and decrypted successfully!")
            else:
                QMessageBox.warning(self, "Error", f"Download failed: {message}")
        
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Download error: {str(e)}")
    
    def delete_file(self, file_info):
        reply = QMessageBox.question(
            self,
            "Delete File",
            f"Are you sure you want to delete '{file_info['name']}'?\n"
            "This action cannot be undone.",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            success, message = self.dropbox_mgr.delete_file(file_info['path'])
            
            if success:
                QMessageBox.information(self, "Success", "File deleted successfully!")
                self.refresh_files()
            else:
                QMessageBox.warning(self, "Error", f"Delete failed: {message}")

# ---------- FILE CARD WIDGET ----------
class FileCardWidget(QWidget):
    def __init__(self, file_info, on_download, on_delete):
        super().__init__()
        self.file_info = file_info
        self.on_download = on_download
        self.on_delete = on_delete
        
        self.setFixedSize(150, 180)
        self.setStyleSheet("""
            FileCardWidget {
                background-color: #2b2b2b;
                border-radius: 8px;
                border: 1px solid #333333;
            }
            FileCardWidget:hover {
                background-color: #333333;
            }
        """)
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.setSpacing(8)
        
        icon_label = QLabel("üìÑ")
        icon_label.setStyleSheet("font-size: 48px; border: none; background: transparent;")
        icon_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        name_label = QLabel(file_info['name'])
        name_label.setObjectName("fileNameLabel")
        name_label.setWordWrap(True)
        name_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        name_label.setMaximumHeight(40)
        
        size_kb = file_info['size'] / 1024
        size_label = QLabel(f"{size_kb:.1f} KB")
        size_label.setObjectName("infoLabel")
        size_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        btn_layout = QHBoxLayout()
        btn_layout.setSpacing(5)
        
        self.download_btn = QPushButton("‚¨á")
        self.download_btn.setObjectName("icon")
        self.download_btn.setFixedSize(30, 30)
        self.download_btn.setToolTip("Download")
        
        self.delete_btn = QPushButton("üóë")
        self.delete_btn.setObjectName("icon")
        self.delete_btn.setFixedSize(30, 30)
        self.delete_btn.setToolTip("Delete")
        
        if not file_info['has_key']:
            self.download_btn.setEnabled(False)
            self.download_btn.setToolTip("You don't have the decryption key")
        
        btn_layout.addWidget(self.download_btn)
        btn_layout.addWidget(self.delete_btn)
        
        layout.addWidget(icon_label)
        layout.addWidget(name_label)
        layout.addWidget(size_label)
        layout.addStretch()
        layout.addLayout(btn_layout)
        
        self.download_btn.clicked.connect(lambda: self.on_download(self.file_info))
        self.delete_btn.clicked.connect(lambda: self.on_delete(self.file_info))

# ---------- DROPBOX AUTH DIALOG ----------
class DropboxAuthDialog(QDialog):
    def __init__(self, parent, auth_url):
        super().__init__(parent)
        self.setWindowTitle("Dropbox Authorization")
        self.setFixedSize(450, 200)
        self.setModal(True)
        
        layout = QVBoxLayout(self)
        layout.setSpacing(15)
        
        info = QLabel("A browser window has been opened for Dropbox authorization.\n"  "After authorizing, copy the code and paste it below:")
        info.setWordWrap(True)
        info.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        self.code_input = QLineEdit()
        self.code_input.setPlaceholderText("Paste authorization code here...")
        
        btn_layout = QHBoxLayout()
        self.ok_btn = QPushButton("Authorize")
        self.ok_btn.setObjectName("success")
        self.cancel_btn = QPushButton("Cancel")
        self.cancel_btn.setObjectName("secondary")
        
        btn_layout.addWidget(self.ok_btn)
        btn_layout.addWidget(self.cancel_btn)
        
        layout.addWidget(info)
        layout.addWidget(self.code_input)
        layout.addLayout(btn_layout)
        
        self.ok_btn.clicked.connect(self.accept)
        self.cancel_btn.clicked.connect(self.reject)
        self.code_input.returnPressed.connect(self.accept)
    
    def get_code(self):
        return self.code_input.text().strip()

# ---------- SECURE SESSION CONFIRMATION DIALOG ----------
class SecureSessionDialog(QFrame):
    def __init__(self, parent, peer, on_accept, on_reject):
        super().__init__(parent)
        self.setObjectName("ConfirmDialog")
        self.setFixedSize(400, 250)
        self.on_accept = on_accept
        self.on_reject = on_reject
        self.peer = peer
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.SubWindow)

        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        title = QLabel("üîí Secure Session Request")
        title.setStyleSheet("font-size: 18px; font-weight: bold; border: none; background: transparent;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        message = QLabel(
            f"<b>{peer}</b> wants to start a secure session.\n\n"
            "If you accept:\n"
            "‚Ä¢ All messages will be encrypted\n"
            "‚Ä¢ Messages will be deleted for BOTH users after closing\n"
            "‚Ä¢ No traces will remain for forensic recovery"
        )
        message.setStyleSheet("font-size: 13px; border: none; background: transparent;")
        message.setWordWrap(True)
        message.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        btn_layout = QHBoxLayout()
        self.accept_btn = QPushButton("ACCEPT")
        self.accept_btn.setObjectName("success")
        self.reject_btn = QPushButton("DECLINE")
        self.reject_btn.setObjectName("danger")
        
        btn_layout.addWidget(self.accept_btn)
        btn_layout.addWidget(self.reject_btn)
        
        layout.addWidget(title)
        layout.addWidget(message)
        layout.addStretch()
        layout.addLayout(btn_layout)

        self.accept_btn.clicked.connect(self.accept)
        self.reject_btn.clicked.connect(self.reject)

    def accept(self):
        self.on_accept(self.peer)
        self.close_dialog()

    def reject(self):
        self.on_reject(self.peer)
        self.close_dialog()
    
    def close_dialog(self):
        self.parent().fade_out()
        self.deleteLater()

# ---------- CONFIRMATION DIALOG ----------
class CustomDeleteDialog(QFrame):
    def __init__(self, parent, msg_id, on_confirm):
        super().__init__(parent)
        self.setObjectName("ConfirmDialog")
        self.setFixedSize(320, 180)
        self.on_confirm = on_confirm
        self.msg_id = msg_id
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.SubWindow)

        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        label = QLabel("Delete message?")
        label.setStyleSheet("font-size: 18px; font-weight: bold; border: none; background: transparent;")
        label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        self.checkbox = QCheckBox("Delete for everyone")
        self.checkbox.setChecked(True)
        self.checkbox.setStyleSheet("border: none; background: transparent; font-size: 13px;")
        
        btn_lay = QHBoxLayout()
        self.yes_btn = QPushButton("DELETE")
        self.yes_btn.setObjectName("danger")
        self.no_btn = QPushButton("CANCEL")
        self.no_btn.setObjectName("secondary")
        
        btn_lay.addWidget(self.yes_btn)
        btn_lay.addWidget(self.no_btn)
        
        layout.addWidget(label)
        layout.addStretch()
        layout.addWidget(self.checkbox)
        layout.addLayout(btn_lay)

        self.no_btn.clicked.connect(self.cancel)
        self.yes_btn.clicked.connect(self.confirm)

    def cancel(self):
        self.parent().fade_out()
        self.deleteLater()

    def confirm(self):
        self.on_confirm(self.msg_id, self.checkbox.isChecked())
        self.cancel()

# ---------- LOGIN WINDOW ----------
class LoginWindow(QWidget):
    def __init__(self, net):
        super().__init__()
        self.net = net
        self.plausible = get_plausible_deniability()
        self.setWindowTitle("Chat Login")
        self.setFixedSize(350, 320)

        lay = QVBoxLayout(self)
        lay.setSpacing(15)
        lay.setContentsMargins(40, 30, 40, 30)

        title = QLabel("Chat")
        title.setStyleSheet("font-size: 24px; font-weight: bold; color: #0078d4;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)

        self.user = QLineEdit()
        self.user.setPlaceholderText("Username")
        self.passw = QLineEdit()
        self.passw.setPlaceholderText("Password")
        self.passw.setEchoMode(QLineEdit.EchoMode.Password)

        self.login_btn = QPushButton("SIGN IN")
        self.reg_btn = QPushButton("SIGN UP")
        self.reg_btn.setObjectName("secondary")

        lay.addWidget(title)
        lay.addWidget(self.user)
        lay.addWidget(self.passw)
        lay.addWidget(self.login_btn)
        lay.addWidget(self.reg_btn)

        self.login_btn.clicked.connect(self.handle_login)
        self.reg_btn.clicked.connect(lambda: self.net.register(self.user.text(), self.passw.text()))
        self.passw.returnPressed.connect(self.handle_login)

    def handle_login(self):
        username = self.user.text().strip()
        password = self.passw.text()
        
        if not username or not password:
            QMessageBox.warning(self, "Error", "Please enter username and password")
            return
        
        print(f"[DEBUG] Attempting login for user: {username}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞—Ä–æ–ª—å —Ñ–µ–π–∫–æ–≤—ã–º
        is_decoy = self.plausible.is_decoy_password(username, password)
        
        if is_decoy:
            print(f"[PLAUSIBLE] User {username} logging in with DECOY password")
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            self.net.login(username, password, is_decoy=True)
        else:
            # –û–±—ã—á–Ω—ã–π –≤—Ö–æ–¥
            print(f"[LOGIN] User {username} logging in with NORMAL password")
            self.net.login(username, password, is_decoy=False)

# ---------- CHAT WINDOW ----------
class Signals(QObject):
    auth = pyqtSignal(dict)
    users = pyqtSignal(list)
    message = pyqtSignal(str, object, object) 
    history = pyqtSignal(str, list)
    delete = pyqtSignal(int)
    msg_sent = pyqtSignal(int, str, object)
    secure_chat_closed = pyqtSignal(str)
    secure_session_request = pyqtSignal(str)
    secure_session_response = pyqtSignal(str, bool)

class ChatWindow(QWidget):
    def __init__(self, net, username, dropbox_mgr):
        super().__init__()
        self.net = net
        self.username = username
        self.dropbox_mgr = dropbox_mgr
        self.peer = None
        self.bubbles = {}
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–æ—Ä–µ–Ω–∑–∏–∫–∏
        self.forensic = get_forensic_protection()
        self.secure_storage = get_secure_storage()
        self.plausible = get_plausible_deniability()
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞–º
        self.secure_sessions = {}

        self.setWindowTitle(f"User: {username}")
        self.resize(1200, 750)
        self.setMinimumSize(900, 600)

        # –û—Å–Ω–æ–≤–Ω–æ–π layout
        main_lay = QHBoxLayout(self)
        main_lay.setContentsMargins(0,0,0,0)
        main_lay.setSpacing(0)

        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
        left_panel = QWidget()
        left_panel.setMaximumWidth(300)
        left_lay = QVBoxLayout(left_panel)
        left_lay.setContentsMargins(10, 10, 10, 10)
        
        self.user_list = QListWidget()
        
        btn_layout = QHBoxLayout()
        btn_layout.setSpacing(10)
        
        self.refresh_btn = QPushButton("Refresh contacts")
        self.refresh_btn.setObjectName("secondary")
        
        # –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é (—Ç—Ä–∏ –ø–æ–ª–æ—Å–∫–∏)
        self.menu_btn = QPushButton("‚ò∞")
        self.menu_btn.setObjectName("secondary")
        self.menu_btn.setFixedWidth(50)
        self.menu_btn.setToolTip("Menu")
        self.menu_btn.clicked.connect(self.toggle_sidebar)
        
        btn_layout.addWidget(self.menu_btn, 0)
        btn_layout.addWidget(self.refresh_btn, 1)
        
        left_lay.addWidget(self.user_list)
        left_lay.addLayout(btn_layout)

        # Chat Area
        right_panel = QWidget()
        right_lay = QVBoxLayout(right_panel)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ —Å –∫–Ω–æ–ø–∫–æ–π –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        header_layout = QHBoxLayout()
        self.chat_title = QLabel("Select a contact...")
        self.chat_title.setStyleSheet("font-weight: bold; color: #0078d4; font-size: 16px;")
        
        header_layout.addWidget(self.chat_title)
        header_layout.addStretch()
        
        # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        self.secure_indicator = QLabel()
        self.secure_indicator.setStyleSheet("""
            background-color: #2b2b2b;
            color: #888888;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        """)
        self.secure_indicator.hide()
        
        self.chat_area = QVBoxLayout()
        self.chat_area.addStretch()
        
        container = QWidget()
        container.setLayout(self.chat_area)
        
        self.scroll = QScrollArea()
        self.scroll.setWidget(container)
        self.scroll.setWidgetResizable(True)

        input_lay = QHBoxLayout()
        self.file_btn = QPushButton("üìé")
        self.file_btn.setFixedWidth(40)
        self.file_btn.clicked.connect(self.send_file_dialog)
        input_lay.addWidget(self.file_btn)
        self.input = QLineEdit()
        self.input.setPlaceholderText("Type a message...")
        self.send_btn = QPushButton("Send")
        input_lay.addWidget(self.input)
        input_lay.addWidget(self.send_btn)

        right_lay.addLayout(header_layout)
        right_lay.addWidget(self.secure_indicator)
        right_lay.addWidget(self.scroll)
        right_lay.addLayout(input_lay)

        main_lay.addWidget(left_panel, 1)
        main_lay.addWidget(right_panel, 3)

        # Overlay –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
        self.overlay = OverlayWidget(self)
        self.overlay.setGeometry(0, 0, self.width(), self.height())

        # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞)
        self.sidebar = SidebarPanel(self)
        self.sidebar.hide()
        
        # –°—Ç–µ–∫–æ–≤—ã–π –≤–∏–¥–∂–µ—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É Files –∏ Settings
        self.sidebar_stack = QStackedWidget(self.sidebar)
        
        # –ü–∞–Ω–µ–ª—å —Ñ–∞–π–ª–æ–≤
        self.files_panel = FilesPanel(self.sidebar, self.dropbox_mgr)
        
        # –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
        self.settings_panel = SettingsPanel(self.sidebar, self)
        
        self.sidebar_stack.addWidget(self.files_panel)
        self.sidebar_stack.addWidget(self.settings_panel)
        
        # Layout –¥–ª—è sidebar
        sidebar_layout = QVBoxLayout(self.sidebar)
        sidebar_layout.setContentsMargins(0, 0, 0, 0)
        
        # –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        tabs_layout = QHBoxLayout()
        tabs_layout.setSpacing(0)
        tabs_layout.setContentsMargins(0, 0, 0, 0)
        
        self.files_tab_btn = QPushButton("Files")
        self.files_tab_btn.setObjectName("tab")
        self.files_tab_btn.setCheckable(True)
        self.files_tab_btn.setChecked(True)
        self.files_tab_btn.clicked.connect(lambda: self.switch_sidebar_tab(0))
        
        self.settings_tab_btn = QPushButton("Settings")
        self.settings_tab_btn.setObjectName("tab")
        self.settings_tab_btn.setCheckable(True)
        self.settings_tab_btn.clicked.connect(lambda: self.switch_sidebar_tab(1))
        
        tabs_layout.addWidget(self.files_tab_btn)
        tabs_layout.addWidget(self.settings_tab_btn)

        sidebar_layout.addLayout(tabs_layout)
        sidebar_layout.addWidget(self.sidebar_stack)

        self.refresh_btn.clicked.connect(lambda: self.net.send({"type": "get_users"}))
        self.user_list.itemClicked.connect(self.select_peer)
        self.send_btn.clicked.connect(self.send_msg)
        self.input.returnPressed.connect(self.send_msg)

    def resizeEvent(self, event):
        super().resizeEvent(event)
        self.overlay.setGeometry(0, 0, self.width(), self.height())
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É sidebar –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        if self.sidebar.is_open:
            self.sidebar.setGeometry(0, 0, 350, self.height())
        else:
            self.sidebar.setGeometry(-350, 0, 350, self.height())

    def toggle_sidebar(self):
        if self.sidebar.is_open:
            self.overlay.fade_out()
            self.sidebar.slide_out()
        else:
            self.overlay.fade_in()
            self.sidebar.slide_in()
        
    def switch_sidebar_tab(self, index):
        self.sidebar_stack.setCurrentIndex(index)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        self.files_tab_btn.setChecked(index == 0)
        self.settings_tab_btn.setChecked(index == 1)

    def show_plausible_deniability_dialog(self):
        self.close_sidebar()
        
        QTimer.singleShot(300, lambda: self._show_plausible_dialog())
    
    def _show_plausible_dialog(self):
        self.overlay.fade_in()
        dialog = PlausibleDeniabilityDialog(
            self.overlay,
            self.on_plausible_confirm,
            self.on_plausible_cancel
        )
        dialog.move((self.width() - 400) // 2, (self.height() - 250) // 2)
        dialog.show()
    
    def on_plausible_confirm(self, decoy_password):
        if not decoy_password:
            QMessageBox.warning(self, "Error", "Decoy password cannot be empty!")
            return
        
        try:
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∞–ª—å—à–∏–≤—ã–π –ø–∞—Ä–æ–ª—å
            decoy_username = self.plausible.setup_decoy_password(
                self.username,
                decoy_password
            )
            
            QMessageBox.information(
                self,
                "Success",
                f"Decoy password set successfully!\n\n"
                f"Decoy username: {decoy_username}\n\n"
                f"When you log in with the decoy password, "
                f"you'll see a fake chat with innocent messages."
            )
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Failed to setup decoy password: {str(e)}")
    
    def on_plausible_cancel(self):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ plausible deniability"""
        pass

    def is_secure_session_active(self):
        if not self.peer:
            return False
        return self.secure_sessions.get(self.peer, False)

    def toggle_secure_mode(self):
        if not self.peer:
            QMessageBox.warning(self, "No Contact", "Please select a contact first.")
            return
        
        if self.is_secure_session_active():
            reply = QMessageBox.question(
                self,
                "Disable Secure Session",
                "‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\n"
                "Disabling secure session will:\n"
                "‚Ä¢ Keep current messages in memory\n"
                "‚Ä¢ Stop auto-deletion on chat close\n"
                "‚Ä¢ Disable memory wiping\n\n"
                "Are you sure?",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
            )
            
            if reply == QMessageBox.StandardButton.Yes:
                self.disable_secure_session()
        else:
            self.request_secure_session()

    def request_secure_session(self):
        if not self.peer:
            return
        
        self.net.send({
            "type": "secure_session_request",
            "peer": self.peer
        })
        
        QMessageBox.information(
            self,
            "Request Sent",
            f"Secure session request sent to {self.peer}.\nWaiting for response..."
        )

    def show_secure_session_request(self, peer):
        self.overlay.fade_in()
        dialog = SecureSessionDialog(
            self.overlay,
            peer,
            self.accept_secure_session,
            self.reject_secure_session
        )
        dialog.move((self.width() - 400) // 2, (self.height() - 250) // 2)
        dialog.show()

    def accept_secure_session(self, peer):
        self.net.send({
            "type": "secure_session_response",
            "peer": peer,
            "accepted": True
        })
        
        self.enable_secure_session(peer)
        
        QMessageBox.information(
            self,
            "Secure Session Started",
            f"Secure session with {peer} is now active.\n"
            f"All messages will be encrypted and auto-deleted."
        )

    def reject_secure_session(self, peer):
        self.net.send({
            "type": "secure_session_response",
            "peer": peer,
            "accepted": False
        })
        
        QMessageBox.information(
            self,
            "Request Declined",
            f"You declined the secure session request from {peer}."
        )

    def on_secure_session_response(self, peer, accepted):
        if accepted:
            self.enable_secure_session(peer)
            QMessageBox.information(
                self,
                "Secure Session Started",
                f"{peer} accepted your request!\n"
                f"Secure session is now active."
            )
        else:
            QMessageBox.warning(
                self,
                "Request Declined",
                f"{peer} declined your secure session request."
            )

    def enable_secure_session(self, peer):
        self.secure_sessions[peer] = True
        self.forensic.enable_secure_mode()
        
        if self.peer == peer:
            self.update_secure_ui()

    def disable_secure_session(self):
        if not self.peer:
            return
        
        self.secure_sessions[self.peer] = False
        self.forensic.disable_secure_mode()
        
        self.update_secure_ui()
        
        self.net.send({
            "type": "msg",
            "to": self.peer,
            "payload": "Secure mode disabled",
            "system": True
        })

    def update_secure_ui(self):
        if self.is_secure_session_active():
            self.secure_mode_toggle.setText("SECURE MODE")
            self.secure_mode_toggle.setObjectName("success")
            self.secure_mode_toggle.setStyle(self.secure_mode_toggle.style())
            
            self.secure_indicator.setText(
                "SECURE SESSION ACTIVE - Messages will be erased FOR BOTH USERS after closing"
            )
            self.secure_indicator.setStyleSheet("""
                background-color: #28a745;
                color: white;
                padding: 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
            """)
            self.secure_indicator.show()
        else:
            self.secure_mode_toggle.setText("Normal Mode")
            self.secure_mode_toggle.setObjectName("secondary")
            self.secure_mode_toggle.setStyle(self.secure_mode_toggle.style())
            self.secure_indicator.hide()

    def select_peer(self, item):
        if self.peer and self.is_secure_session_active():
            self.close_secure_chat(self.peer)
        
        self.peer = item.text()
        self.chat_title.setText(f"Chat with {self.peer}")
        self.clear_chat()
        
        self.update_secure_ui()
        
        if self.is_secure_session_active():
            messages = self.secure_storage.get_messages(self.peer)
            for msg in messages:
                self.bubble(msg['data']['payload'], msg['data']['mine'], msg['id'])
        else:
            self.net.send({"type": "get_history", "with": self.peer})

    def close_secure_chat(self, peer):
        if not self.secure_sessions.get(peer, False):
            return
        
        try:
            self.net.close_secure_chat(peer)
            self.secure_storage.clear_peer_messages(peer, self.forensic)
            self.forensic.secure_wipe_memory()
            self.secure_sessions[peer] = False
            print(f"[SECURE] Chat with {peer} securely closed")
        except Exception as e:
            print(f"[ERROR] Error closing secure chat: {e}")

    def send_file_dialog(self):
        path, _ = QFileDialog.getOpenFileName(self, "Select file", "", "All Files (*)")
        if path and self.peer:
            fname = os.path.basename(path)
            with open(path, "rb") as f:
                file_bytes = f.read()
            
            key = self.net.get_key(self.peer)
            if key:
                encrypted_payload = encrypt_msg(key, file_bytes)
                final_payload = f"FILE:{fname}:{json.dumps(encrypted_payload)}"
                self.net.send_message(self.peer, final_payload)

    def save_file(self, filename, data):
        path, _ = QFileDialog.getSaveFileName(self, "Save file", filename)
        if path:
            with open(path, 'wb') as f:
                f.write(data)
            
            if self.is_secure_session_active():
                self.forensic.register_temp_file(path)
                QMessageBox.information(
                    self, 
                    "File Saved", 
                    f"File saved successfully!\n\n"
                    f"‚ö†Ô∏è SECURE MODE: This file will be securely deleted when you close the app."
                )
            else:
                QMessageBox.information(self, "Done", "File successfully saved")

    def upload_to_dropbox(self, filename, data):
        if not self.dropbox_mgr.is_authenticated():
            reply = QMessageBox.question(
                self,
                "Connect Dropbox",
                "You need to connect to Dropbox first.\nWould you like to do it now?",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
            )
            
            if reply == QMessageBox.StandardButton.Yes:
                self.open_sidebar()
                self.switch_sidebar_tab(0)
            return
        
        try:
            # progress = QMessageBox(self)
            # progress.setWindowTitle("Uploading...")
            # progress.setText(f"Uploading {filename} to Dropbox...")
            # progress.setStandardButtons(QMessageBox.StandardButton.NoButton)
            # progress.show()
            QApplication.processEvents()
            
            success, path, key = self.dropbox_mgr.upload_file(filename, data)
            
            # progress.close()
            
            if success:
                QMessageBox.information(
                    self,
                    "Success",
                    f"File '{filename}' successfully uploaded to Dropbox!\n\n"
                    f"The file is encrypted and only you can decrypt it."
                )
            else:
                QMessageBox.warning(self, "Error", f"Upload failed: {path}")
        
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Upload error: {str(e)}")

    def clear_chat(self):
        self.bubbles.clear()
        while self.chat_area.count() > 1:
            i = self.chat_area.takeAt(0)
            if i.widget(): i.widget().deleteLater()

    def decrypt_payload(self, payload, peer):
        key = self.net.get_key(peer)
        
        if isinstance(payload, dict) and 'nonce' in payload and 'ciphertext' in payload:
            try:
                decrypted_bytes = decrypt_msg(key, payload)
                return decrypted_bytes.decode('utf-8')
            except Exception as e:
                print(f"[DECRYPT ERROR] {e}")
                return "Decrypt error"
        
        elif isinstance(payload, str) and payload.startswith("FILE:"):
            return payload
        
        else:
            return str(payload)

    def bubble(self, payload, mine, msg_id=None):
        widget = QWidget()
        row = QHBoxLayout(widget)
        
        is_file = False
        file_name = None
        file_bytes = None
        display_text = payload
        lbl = None

        if isinstance(payload, dict) and 'nonce' in payload and 'ciphertext' in payload:
            display_text = self.decrypt_payload(payload, self.peer)
            
        elif isinstance(payload, str) and payload.startswith("FILE:"):
            try:
                parts = payload.split(":", 2)
                file_name = parts[1]
                encrypted_data_json = parts[2]
                
                key = self.net.get_key(self.peer)
                
                if key:
                    encrypted_dict = json.loads(encrypted_data_json)
                    file_bytes = decrypt_msg(key, encrypted_dict)
                    is_file = True
                    
                    if file_name.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp')):
                        lbl = QLabel()
                        pix = QPixmap()
                        if pix.loadFromData(file_bytes):
                            lbl.setPixmap(pix.scaled(250, 250, Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation))
                        else:
                            lbl = QLabel(f"‚ùå Format error: {file_name}")
                    else:
                        lbl = QLabel(f"üìÑ {file_name}\n(File encrypted)")
                else:
                    lbl = QLabel(f"‚ùå Error: Key not found")
            except Exception as e:
                lbl = QLabel(f"‚ùå Decryption error")
                print(f"Decrypt error: {e}")
                traceback.print_exc()

        if lbl is None:
            lbl = QLabel(str(display_text))

        lbl.setWordWrap(True)
        lbl.setMaximumWidth(500)
        
        bubble_color = '#0078d4' if mine else '#2b2b2b'
        
        lbl.setStyleSheet(f"""
            background-color: {bubble_color}; 
            color: white; 
            padding: 10px; 
            border-radius: 10px;
        """)
        
        lbl.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        lbl.customContextMenuRequested.connect(
            lambda pos, mid=msg_id, fn=file_name, fb=file_bytes, is_f=is_file: 
            self.show_context_menu(pos, lbl, mid, is_f, fn, fb)
        )

        if mine:
            row.addStretch()
            row.addWidget(lbl)
        else:
            row.addWidget(lbl)
            row.addStretch()

        self.chat_area.insertWidget(self.chat_area.count() - 1, widget)
        
        if msg_id is not None:
            self.bubbles[msg_id] = widget
            
            if self.is_secure_session_active():
                self.secure_storage.add_message(self.peer, msg_id, {
                    'payload': payload,
                    'mine': mine
                })
        
        self.scroll.verticalScrollBar().setValue(self.scroll.verticalScrollBar().maximum())

    def show_context_menu(self, pos, target_widget, msg_id, is_file, filename, data):
        if is_file and (filename is None or data is None):
            return
        
        menu = QMenu(self)
        menu.setStyleSheet("QMenu { background-color: #242424; color: white; border: 1px solid #333; }")
        
        save_act = None
        copy_act = None
        upload_act = None
        
        if is_file:
            save_act = menu.addAction("Save file as...")
            upload_act = menu.addAction("Upload to Dropbox")
            copy_act = menu.addAction("Copy file name")
        else:
            copy_act = menu.addAction("Copy text")

        del_act = menu.addAction("Delete")
        
        action = menu.exec(target_widget.mapToGlobal(pos))
        
        if action is not None:
            if is_file and action is save_act:
                self.save_file(filename, data)
            elif is_file and action is upload_act:
                self.upload_to_dropbox(filename, data)
            elif action is copy_act:
                text_to_copy = filename if is_file else target_widget.text()
                QGuiApplication.clipboard().setText(text_to_copy)
            elif action is del_act:
                if msg_id is not None:
                    self.ask_delete(msg_id)

    def ask_delete(self, msg_id):
        self.overlay.fade_in()
        dialog = CustomDeleteDialog(self.overlay, msg_id, self.finish_delete)
        dialog.move((self.width()-320)//2, (self.height()-180)//2)
        dialog.show()

    def finish_delete(self, msg_id, for_all):
        if msg_id in self.bubbles:
            self.bubbles[msg_id].deleteLater()
            del self.bubbles[msg_id]
        
        if self.is_secure_session_active():
            self.secure_storage.remove_message(msg_id)
        
        self.net.delete_message(msg_id, for_all)

    def send_msg(self):
        txt = self.input.text().strip()
        if txt and self.peer:
            key = self.net.get_key(self.peer)
            if key:
                encrypted_payload = encrypt_msg(key, txt.encode())
                self.net.send_message(
                    self.peer, 
                    encrypted_payload, 
                    secure_mode=self.is_secure_session_active()
                )
            else:
                self.net.send_message(
                    self.peer, 
                    txt, 
                    secure_mode=self.is_secure_session_active()
                )
            
            self.input.clear()

    def on_msg_sent(self, msg_id, to_user, payload):
        if to_user == self.peer:
            self.bubble(payload, True, msg_id)

    def remove_by_id(self, msg_id):
        if msg_id in self.bubbles:
            self.bubbles[msg_id].deleteLater()
            del self.bubbles[msg_id]
        
        if self.is_secure_session_active():
            self.secure_storage.remove_message(msg_id)

    def history(self, messages):
        if self.is_secure_session_active():
            return
        
        self.clear_chat()
        for m in messages:
            self.bubble(m["payload"], m["sender"] == self.username, m["id"])

    def closeEvent(self, event):
        active_sessions = [peer for peer, active in self.secure_sessions.items() if active]
        
        if active_sessions:
            reply = QMessageBox.question(
                self,
                "Exit Secure Sessions",
                f"üîí YOU HAVE {len(active_sessions)} ACTIVE SECURE SESSION(S)\n\n"
                f"All messages will be securely erased FOR BOTH USERS:\n"
                f"‚Ä¢ Messages deleted from database\n"
                f"‚Ä¢ Memory overwritten\n"
                f"‚Ä¢ Temporary files wiped\n"
                f"‚Ä¢ Your conversation partners will also lose these messages\n\n"
                f"This cannot be undone. Continue?",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
            )
            
            if reply == QMessageBox.StandardButton.No:
                event.ignore()
                return
            
            try:
                for peer in active_sessions:
                    self.close_secure_chat(peer)
                
                self.secure_storage.secure_cleanup_all(self.forensic)
                self.forensic.cleanup_temp_files()
                self.forensic.secure_overwrite_ram(10)
                
                print("[SECURE] Application closed securely")
                
            except Exception as e:
                print(f"[ERROR] Error during secure cleanup: {e}")
        
        event.accept()

# ---------- EMPTY SETTINGS PANEL (–¥–ª—è —Ñ–µ–π–∫–æ–≤–æ–≥–æ —á–∞—Ç–∞) ----------
class EmptySettingsPanel(QWidget):
    def __init__(self, parent):
        super().__init__(parent)
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header = QLabel("‚öôÔ∏è Settings")
        header.setStyleSheet("font-size: 20px; font-weight: bold;")
        
        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        line1 = QFrame()
        line1.setFrameShape(QFrame.Shape.HLine)
        line1.setStyleSheet("background-color: #333333;")
        
        # –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        empty_label = QLabel("No settings available")
        empty_label.setStyleSheet("font-size: 14px; color: #888888;")
        empty_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        layout.addWidget(header)
        layout.addWidget(line1)
        layout.addStretch()
        layout.addWidget(empty_label)
        layout.addStretch()

# ---------- FAKE FILES PANEL ----------
class FakeFilesPanel(QWidget):
    def __init__(self, parent):
        super().__init__(parent)
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header = QLabel("üìÅ My Files")
        header.setStyleSheet("font-size: 20px; font-weight: bold;")
        
        # –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        status_layout = QHBoxLayout()
        self.status_label = QLabel("Not connected")
        self.status_label.setObjectName("statusLabel")
        self.status_label.setStyleSheet("background-color: #bb2d3b; padding: 5px; border-radius: 4px;")
        
        connect_btn = QPushButton("Connect Dropbox")
        connect_btn.setEnabled(False)  # –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞
        
        status_layout.addWidget(self.status_label)
        status_layout.addStretch()
        status_layout.addWidget(connect_btn)
        
        # –ü—É—Å—Ç–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Ñ–∞–π–ª–æ–≤
        empty_label = QLabel("No files available")
        empty_label.setStyleSheet("font-size: 14px; color: #888888;")
        empty_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        layout.addWidget(header)
        layout.addLayout(status_layout)
        layout.addStretch()
        layout.addWidget(empty_label)
        layout.addStretch()

# ---------- FAKE CHAT WINDOW ----------
class FakeChatWindow(QWidget):
    """
    –§–µ–π–∫–æ–≤–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ —Å –Ω–µ–≤–∏–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
    –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–º–∏—Ç–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π —á–∞—Ç, –Ω–æ —Å —Ñ–µ–π–∫–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    """
    
    def __init__(self, net, username, dropbox_mgr):
        super().__init__()
        self.net = net
        self.username = username
        self.dropbox_mgr = dropbox_mgr
        self.peer = None
        self.plausible = get_plausible_deniability()
        self.current_dialog = None
        
        self.setWindowTitle(f"User: {username}")
        self.resize(1200, 750)
        self.setMinimumSize(900, 600)

        # –û—Å–Ω–æ–≤–Ω–æ–π layout
        main_lay = QHBoxLayout(self)
        main_lay.setContentsMargins(0,0,0,0)
        main_lay.setSpacing(0)

        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
        left_panel = QWidget()
        left_panel.setMaximumWidth(300)
        left_lay = QVBoxLayout(left_panel)
        left_lay.setContentsMargins(10, 10, 10, 10)
        
        self.user_list = QListWidget()
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–µ–π–∫–æ–≤—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
        fake_contacts = self.plausible.get_fake_contacts()
        for contact in fake_contacts:
            self.user_list.addItem(contact)
        
        btn_layout = QHBoxLayout()
        btn_layout.setSpacing(10)
        
        # –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é (—Ç—Ä–∏ –ø–æ–ª–æ—Å–∫–∏)
        self.menu_btn = QPushButton("‚ò∞")
        self.menu_btn.setObjectName("secondary")
        self.menu_btn.setFixedWidth(50)
        self.menu_btn.setToolTip("Menu")
        self.menu_btn.clicked.connect(self.toggle_sidebar)
        
        refresh_btn = QPushButton("Refresh contacts")
        refresh_btn.setObjectName("secondary")
        refresh_btn.clicked.connect(self.refresh_contacts)
        
        btn_layout.addWidget(self.menu_btn, 0)
        btn_layout.addWidget(refresh_btn, 1)
        
        left_lay.addWidget(self.user_list)
        left_lay.addLayout(btn_layout)

        # Chat Area
        right_panel = QWidget()
        right_lay = QVBoxLayout(right_panel)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
        header_layout = QHBoxLayout()
        self.chat_title = QLabel("Select a contact...")
        self.chat_title.setStyleSheet("font-weight: bold; color: #0078d4; font-size: 16px;")
        header_layout.addWidget(self.chat_title)
        header_layout.addStretch()
        
        self.chat_area = QVBoxLayout()
        self.chat_area.addStretch()
        
        container = QWidget()
        container.setLayout(self.chat_area)
        
        self.scroll = QScrollArea()
        self.scroll.setWidget(container)
        self.scroll.setWidgetResizable(True)

        input_lay = QHBoxLayout()
        
        # –ö–Ω–æ–ø–∫–∞ —Ñ–∞–π–ª–∞ (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è)
        file_btn = QPushButton("üìé")
        file_btn.setFixedWidth(40)
        file_btn.setEnabled(False)
        
        self.input = QLineEdit()
        self.input.setPlaceholderText("Type a message...")
        send_btn = QPushButton("Send")
        send_btn.clicked.connect(self.fake_send)
        
        input_lay.addWidget(file_btn)
        input_lay.addWidget(self.input)
        input_lay.addWidget(send_btn)

        right_lay.addLayout(header_layout)
        right_lay.addWidget(self.scroll)
        right_lay.addLayout(input_lay)

        main_lay.addWidget(left_panel, 1)
        main_lay.addWidget(right_panel, 3)

        # Overlay –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
        self.overlay = OverlayWidget(self, on_click=self.close_sidebar_and_dialogs)
        self.overlay.setGeometry(0, 0, self.width(), self.height())

        # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞)
        self.sidebar = SidebarPanel(self)
        self.sidebar.hide()
        
        # –°—Ç–µ–∫–æ–≤—ã–π –≤–∏–¥–∂–µ—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É Files –∏ Settings
        self.sidebar_stack = QStackedWidget(self.sidebar)
        
        # –§–µ–π–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∞–π–ª–æ–≤
        self.files_panel = FakeFilesPanel(self.sidebar)
        
        # –ü—É—Å—Ç–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
        self.settings_panel = EmptySettingsPanel(self.sidebar)
        
        self.sidebar_stack.addWidget(self.files_panel)
        self.sidebar_stack.addWidget(self.settings_panel)
        
        # Layout –¥–ª—è sidebar
        sidebar_layout = QVBoxLayout(self.sidebar)
        sidebar_layout.setContentsMargins(0, 0, 0, 0)
        
        # –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        tabs_layout = QHBoxLayout()
        tabs_layout.setSpacing(0)
        tabs_layout.setContentsMargins(0, 0, 0, 0)
        
        self.files_tab_btn = QPushButton("Files")
        self.files_tab_btn.setObjectName("tab")
        self.files_tab_btn.setCheckable(True)
        self.files_tab_btn.setChecked(True)
        self.files_tab_btn.clicked.connect(lambda: self.switch_sidebar_tab(0))
        
        self.settings_tab_btn = QPushButton("Settings")
        self.settings_tab_btn.setObjectName("tab")
        self.settings_tab_btn.setCheckable(True)
        self.settings_tab_btn.clicked.connect(lambda: self.switch_sidebar_tab(1))
        
        tabs_layout.addWidget(self.files_tab_btn)
        tabs_layout.addWidget(self.settings_tab_btn)

        sidebar_layout.addLayout(tabs_layout)
        sidebar_layout.addWidget(self.sidebar_stack)

        self.user_list.itemClicked.connect(self.select_peer)
        self.input.returnPressed.connect(self.fake_send)
        
        # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        QTimer.singleShot(100, self.preload_first_chat)
    
    def resizeEvent(self, event):
        super().resizeEvent(event)
        self.overlay.setGeometry(0, 0, self.width(), self.height())
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É sidebar –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        if self.sidebar.is_open:
            self.sidebar.setGeometry(0, 0, 350, self.height())
        else:
            self.sidebar.setGeometry(-350, 0, 350, self.height())

    def toggle_sidebar(self):
        if self.sidebar.is_open:
            self.overlay.fade_out()
            self.sidebar.slide_out()
        else:
            self.overlay.fade_in()
            self.sidebar.slide_in()
    
    def close_sidebar_and_dialogs(self):
        """–ó–∞–∫—Ä—ã—Ç—å sidebar –∏ –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ"""
        if self.sidebar.is_open:
            self.overlay.fade_out()
            self.sidebar.slide_out()
        
    def switch_sidebar_tab(self, index):
        self.sidebar_stack.setCurrentIndex(index)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        self.files_tab_btn.setChecked(index == 0)
        self.settings_tab_btn.setChecked(index == 1)
    
    def preload_first_chat(self):
        """–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤—ã–π —á–∞—Ç –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏"""
        if self.user_list.count() > 0:
            first_item = self.user_list.item(0)
            self.select_peer(first_item)
    
    def refresh_contacts(self):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–µ–π–∫–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""
        current_peer = self.peer
        
        self.user_list.clear()
        fake_contacts = self.plausible.get_fake_contacts()
        for contact in fake_contacts:
            self.user_list.addItem(contact)
        
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if current_peer:
            for i in range(self.user_list.count()):
                if self.user_list.item(i).text() == current_peer:
                    self.user_list.setCurrentRow(i)
                    break
    
    def select_peer(self, item):
        """–í—ã–±—Ä–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞"""
        self.peer = item.text()
        self.chat_title.setText(f"Chat with {self.peer}")
        self.clear_chat()
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        fake_messages = self.plausible.get_fake_messages(self.peer)
        for msg in fake_messages:
            self.show_fake_message(msg['text'], msg['mine'])
    
    def clear_chat(self):
        """–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç"""
        while self.chat_area.count() > 1:
            i = self.chat_area.takeAt(0)
            if i.widget(): 
                i.widget().deleteLater()
    
    def show_fake_message(self, text, mine):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–µ–π–∫–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        widget = QWidget()
        row = QHBoxLayout(widget)
        
        lbl = QLabel(str(text))
        lbl.setWordWrap(True)
        lbl.setMaximumWidth(500)
        
        bubble_color = '#0078d4' if mine else '#2b2b2b'
        
        lbl.setStyleSheet(f"""
            background-color: {bubble_color}; 
            color: white; 
            padding: 10px; 
            border-radius: 10px;
        """)

        if mine:
            row.addStretch()
            row.addWidget(lbl)
        else:
            row.addWidget(lbl)
            row.addStretch()

        self.chat_area.insertWidget(self.chat_area.count() - 1, widget)
        self.scroll.verticalScrollBar().setValue(self.scroll.verticalScrollBar().maximum())
    
    def fake_send(self):
        """–§–µ–π–∫–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä)"""
        txt = self.input.text().strip()
        if txt and self.peer:
            # –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
            self.show_fake_message(txt, True)
            self.input.clear()
            
            # –ß–µ—Ä–µ–∑ 1-3 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç
            responses = [
                "I see",
                "Okay",
                "Got it",
                "Sure!",
                "Alright",
                "üëç",
                "Thanks!",
                "Sounds good",
                "No problem",
                "Cool!",
            ]
            
            QTimer.singleShot(
                random.randint(1000, 3000), 
                lambda: self.show_fake_message(random.choice(responses), False)
            )
    
    def closeEvent(self, event):
        """–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"""
        event.accept()

# ---------- MAIN APP ----------
class App:
    def __init__(self):
        self.app = QApplication(sys.argv)
        current_dir = os.path.dirname(os.path.abspath(__file__))
        style_path = os.path.join(current_dir, "styles.qss")
        
        try:
            with open(style_path, "r", encoding="utf-8") as f:
                style_content = f.read()
                self.app.setStyleSheet(style_content)
        except FileNotFoundError:
            print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª —Å—Ç–∏–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏ {style_path}")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç–∏–ª–µ–π: {e}")
        
        self.dropbox_mgr = DropboxManager()
        
        self.signals = Signals()
        self.net = ClientNetwork(self.signals)
        self.net.connect()

        self.login_win = LoginWindow(self.net)
        self.login_win.show()

        self.signals.auth.connect(self.on_auth)
        self.signals.users.connect(self.on_users)
        self.signals.message.connect(self.on_message)
        self.signals.secure_chat_closed.connect(self.on_secure_chat_closed)
        self.signals.secure_session_request.connect(self.on_secure_session_request)
        self.signals.secure_session_response.connect(self.on_secure_session_response)
        self.signals.history.connect(lambda p,m: self.chat_win.history(m) if self.chat_win else None)
        self.signals.delete.connect(lambda msg_id: self.chat_win.remove_by_id(msg_id) if self.chat_win else None)
        self.signals.msg_sent.connect(lambda mid, to, payload: self.chat_win.on_msg_sent(mid, to, payload) if self.chat_win else None)
        self.chat_win = None

    def on_secure_session_request(self, peer):
        if self.chat_win:
            self.chat_win.show_secure_session_request(peer)

    def on_secure_session_response(self, peer, accepted):
        if self.chat_win:
            self.chat_win.on_secure_session_response(peer, accepted)

    def on_secure_chat_closed(self, peer):
        if self.chat_win:
            try:
                self.chat_win.secure_storage.clear_peer_messages(
                    peer, 
                    self.chat_win.forensic
                )
                
                if self.chat_win.peer == peer:
                    self.chat_win.clear_chat()
                    QMessageBox.information(
                        self.chat_win,
                        "Secure Chat Closed",
                        f"üîí {peer} closed the secure chat.\n"
                        f"All messages have been securely deleted."
                    )
                
                print(f"[SECURE] Messages with {peer} deleted on partner's request")
                
            except Exception as e:
                print(f"[ERROR] Failed to process secure chat closure: {e}")
    
    def on_message(self, sender, payload, msg_id):
        if self.chat_win and sender == self.chat_win.peer:
            self.chat_win.bubble(payload, False, msg_id)

    def on_auth(self, data):
        if data.get("status") == "ok":
            is_decoy_mode = data.get("is_decoy", False)
            
            if is_decoy_mode:
                # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–µ–π–∫–æ–≤–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞
                self.chat_win = FakeChatWindow(
                    self.net, 
                    data["username"], 
                    self.dropbox_mgr
                )
                print(f"[PLAUSIBLE] Opened FAKE chat for {data['username']}")
            else:
                # –û–±—ã—á–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞
                self.chat_win = ChatWindow(
                    self.net, 
                    data["username"], 
                    self.dropbox_mgr
                )
            
            self.chat_win.show()
            self.login_win.close()
            self.net.send({"type": "get_users"})
        else: 
            QMessageBox.warning(None, "Auth Error", data.get("error", "Error"))

    def on_users(self, ul):
        if self.chat_win:
            self.chat_win.user_list.clear()
            for u in ul:
                if u != self.chat_win.username: 
                    self.chat_win.user_list.addItem(u)

    def run(self): 
        sys.exit(self.app.exec())

if __name__ == "__main__":
    App().run()